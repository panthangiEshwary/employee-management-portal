name: Build & Deploy App via GHCR

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # ------------------------------
      # Checkout code
      # ------------------------------
      - uses: actions/checkout@v4

      # ==============================
      # Frontend Build (Angular)
      # ==============================
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Build frontend (production)
        working-directory: frontend
        run: npx ng build --configuration production

      # ==============================
      # Backend Build (Spring Boot)
      # ==============================
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build backend JAR
        working-directory: backend
        run: mvn clean package -DskipTests

      # ==============================
      # Login to GitHub Container Registry
      # ==============================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Set lowercase repo owner
        run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      # ==============================
      # Docker Builds
      # ==============================
      - name: Build Backend Image
        run: |
          docker build \
            -t ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }} \
            backend

      - name: Build Frontend Image
        run: |
          docker build \
            -t ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }} \
            frontend

      # ==============================
      # Push Images
      # ==============================
      - name: Push Images to GHCR
        run: |
          docker push ghcr.io/${REPO_OWNER_LC}/employee-backend:${{ github.run_number }}
          docker push ghcr.io/${REPO_OWNER_LC}/employee-frontend:${{ github.run_number }}
